#!/bin/sh -e

if [ -z "$TOOLS" ]
then
	echo "TOOLS variable is not set"
	exit 1
fi

mkdir -p $TOOLS

# Arm AArch64 cross compiler
cd $TOOLS
if [ ! -f arm-gnu-toolchain-13.3.rel1-x86_64-aarch64-none-elf.tar.xz ]
then
	echo "Downloading Arm AArch64 cross compiler"
	wget https://developer.arm.com/-/media/Files/downloads/gnu/13.3.rel1/binrel/arm-gnu-toolchain-13.3.rel1-x86_64-aarch64-none-elf.tar.xz
fi
if [ ! -d arm-gnu-toolchain-13.3.rel1-x86_64-aarch64-none-elf ]
then
	echo "Extracting Arm AArch64 cross compiler"
	tar -xf arm-gnu-toolchain-13.3.rel1-x86_64-aarch64-none-elf.tar.xz
fi

# QEMU (newer version that supports Raspberry Pi 4 Model B)
cd $TOOLS
if [ ! -d qemu ]
then
	echo "Cloning QEMU"
	git clone git@github.com:qemu/qemu.git
	cd qemu
	git checkout stable-9.1
fi
cd $TOOLS
if [ ! -d qemu/build ]
then
	echo "Building QEMU"
	cd qemu
	mkdir build
	cd build
	../configure
	make
fi

# Raspberry Pi 4 Model B firmware
cd $TOOLS
if [ ! -d firmware ]
then
	echo "Cloning Raspberry Pi 4 Model B firmware"
	git clone --depth=1 --branch=1.20240529 https://github.com/raspberrypi/firmware.git
fi

# OpenOCD
cd $TOOLS
if [ ! -d openocd ]
then
	sudo apt install libusb-1.0-0 libusb-1.0-0-dev libcapstone-dev libjaylink-dev libhidapi-dev
	git clone git://git.code.sf.net/p/openocd/code openocd
	cd openocd/
	./bootstrap
	./configure --enable-jlink --enable-ftdi --enable-cmsis-dap --enable-cmsis-dap-v2
	make -j 6
fi
